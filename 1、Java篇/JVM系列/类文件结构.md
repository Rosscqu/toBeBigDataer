# 	类文件结构



## 1、Java如何实现平台无关性

平台无关性的基石：字节码

语言无关性的基础：虚拟机和字节码存储格式。Java虚拟机不与包括Java语言在内的任何程序语言绑定，只与“Class文件”这种二进制文件格式关联，Class文件包括了Java虚拟机指令集、符号表、若干其他辅助信息。

<img src="../../img/JVM平台无关性.png" alt="image-20200719124556754" style="zoom:50%;" />



Java语言中各种语法、关键字、常量变量和运算符号的语义都会由多条字节码指令组合来表达。



## 2、Class类文件的结构

任何一个Class文件都对应着唯一的一个类或接口的定义信息。

Class文件是一组以8字节为基础单位的二进制流，各个数据项目严格按照顺序紧凑地排列在文件中，中间没有添加任何分隔符，使得整个Class文件中存储的内容几乎全部是程序运行的必要数据，没有空隙存在。

Class文件格式：

- 数据类型：无符号数和表
  - 无符号数：基本的数据类型，以u1、u2、u4、u8来分别表示1个字节、2个字节、4个字节和8个字节的无符号数，无符号数可以表示数字、索引类型、数量值或暗中utf-8编码构成的字符串；
  - 表：由多个无符号数或者其他表作为数据项构成的复合数据类型。所有表的命名习惯以"_info"结尾，整个Class文件本质上可以看成一张表

- 魔数和Class文件的版本
  - 魔数：Class文件的头4个字节`0xCAFFBABE`，作用是确定这个文件是否为 一个能被虚拟机接受的Class文件
  - Class文件版本：紧接魔数的4个字节，第5和第6字节是次版本号，第7和第8字节是主版本号。Class文件校验部分明确要求即使文件格式并未发生变化，虚拟机也必须拒绝执行超过其版本号的Class文件。

- 常量池
  - 数据类型：表类型；

  - 特点：Class文件里的资源仓库，是Class文件结构中与其他项目关联最多的数据，通常也是占用Class文件空间最大的数据项目之一；

  - 常量池入口：u2类型的数据，代表常量池容量技术值，容器计数从1开始，目的是如果后面某些指向常量池的索引值的数据在特定情况下需要表达“不引用任何一个常量池项目”的含义，可以把索引值设置为0表示。

  - 常量池存放的类变量：

    - 字面量：接近Java语言层面的常量概念
    - 符号引用：属于编译层面的概念，主要包括：
      - 被模块导出或开放的包；
      - 类和接口的全限定名；
      - 字段的名称和描述符；
      - 方法的名称和描述符；
      - 方法句柄和方法类型；
      - 动态调用点和动态常量

    Java在进行编译时不会有连接的步骤，Class文件不会保存各个方法、字段最终在内存中的布局信息。当虚拟机做类加载时进行动态连接，将会从常量池中获得对应的符号引用，再在类创建时或运行时解析、翻译到具体的内存地址中。

    查看Java字节码工具：javap -verbose .class文件

    <img src="../../img/Class文件编译后字节码文件.png" alt="image-20200719211546375" style="zoom:50%;" />

    "I"、"V"、"<init>"、"LineNumberTable"、"LocalVariableTable"等是编译器自动生成的，会被字段表、方和法表、属性表所引用，他们被用来描述一些不方便使用“固定字节”进行表达的内容。

    

    访问标志

    位置：常量池结束后紧接着的2个字节

    作用：用于识别一些类或者接口层次的访问信息，包括Class是类还是接口、是否定义为public类、是否定义为abstract类型；如果是类，是否声明为final等

    

